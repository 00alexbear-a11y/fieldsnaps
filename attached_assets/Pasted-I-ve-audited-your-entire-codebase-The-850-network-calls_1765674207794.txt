I've audited your entire codebase. The 850+ network calls are caused by OfflineIndicator re-rendering in an infinite loop. Here's the complete fix:

ðŸ”§ FIX #1: Memoize OfflineIndicator (CRITICAL)
Using Tool
|
Search
React.memo prevent component re-render
View
In Replit, edit client/src/components/OfflineIndicator.tsx:

Copynano client/src/components/OfflineIndicator.tsx
Replace the ENTIRE file with:

Copyimport { useState, useEffect, memo } from 'react';
import { WifiOff } from 'lucide-react';
import { nativeNetwork } from '@/lib/nativeNetwork';
import type { NetworkStatus } from '@/lib/nativeNetwork';

// Memoize to prevent re-renders when parent (App) re-renders
export const OfflineIndicator = memo(function OfflineIndicator() {
  const [networkStatus, setNetworkStatus] = useState<NetworkStatus>({ 
    connected: navigator.onLine, 
    connectionType: 'unknown' 
  });

  useEffect(() => {
    // Only fetch status once on mount
    nativeNetwork.getStatus().then(setNetworkStatus);

    // Set up listener for network changes
    const cleanup = nativeNetwork.addListener(setNetworkStatus);

    return cleanup;
  }, []); // Empty deps - only run on mount/unmount

  if (networkStatus.connected) return null;

  return (
    <div 
      className="fixed top-0 left-0 right-0 z-[100] bg-orange-600 text-white px-4 pt-safe-2 pb-2 text-sm font-medium flex items-center justify-center gap-2 shadow-lg"
      data-testid="banner-offline"
    >
      <WifiOff className="w-4 h-4" />
      <span>You're offline. Changes will sync when you're back online.</span>
    </div>
  );
});
ðŸ”§ FIX #2: Stabilize App.tsx Redirects
Edit client/src/App.tsx, find line 147 and replace the 4 redirect useEffect blocks:

Copynano client/src/App.tsx
Find these lines (around 151-187) and replace with:

Copy  // Redirect authenticated whitelisted users from landing to dashboard or onboarding
  // Non-whitelisted users can stay on landing page
  useEffect(() => {
    if (!isLoading && isAuthenticated && isWhitelisted && location === '/') {
      const targetLocation = needsOnboarding ? '/onboarding' : '/projects';
      if (location !== targetLocation) {
        setLocation(targetLocation);
      }
    }
  }, [isAuthenticated, isWhitelisted, isLoading, needsOnboarding, location, setLocation]);
  
  // Redirect users who need onboarding to /onboarding page
  useEffect(() => {
    if (!isLoading && needsOnboarding && !isOnboardingRoute && !isPublicRoute && location !== '/onboarding') {
      setLocation('/onboarding');
    }
  }, [isLoading, needsOnboarding, isOnboardingRoute, isPublicRoute, location, setLocation]);

  // Redirect unauthenticated users from private routes to landing
  useEffect(() => {
    if (!isLoading && !isAuthenticated && !isPublicRoute && !isOnboardingRoute && location !== '/') {
      setLocation('/');
    }
  }, [isAuthenticated, isLoading, isPublicRoute, isOnboardingRoute, location, setLocation]);

  // Redirect non-whitelisted authenticated users to waitlist
  useEffect(() => {
    if (!isLoading && isAuthenticated && !isWhitelisted && !isPublicRoute && location !== '/waitlist') {
      setLocation('/waitlist');
    }
  }, [isAuthenticated, isLoading, isWhitelisted, isPublicRoute, location, setLocation]);
Key changes:

Added location !== targetLocation checks to prevent redundant redirects
This stops the redirect loop
ðŸ”§ FIX #3: Add Query Deduplication
Edit client/src/hooks/useOfflineFirstProjects.ts:

Copynano client/src/hooks/useOfflineFirstProjects.ts
Find line 58-66 and add refetchOnMount: false:

Copy  const {
    data: serverProjects = [],
    isLoading: isLoadingServer,
    error: serverError,
  } = useQuery<ProjectWithCounts[]>({
    queryKey: ['/api/projects/with-counts'],
    staleTime: 5 * 60 * 1000,
    retry: false,
    refetchOnMount: false,  // âœ… ADD THIS LINE
    refetchOnReconnect: false,  // âœ… ADD THIS LINE
    meta: {
      skipErrorToast: true,
    },
  });
ðŸ”§ FIX #4: Fix Projects.tsx Queries
Edit client/src/pages/Projects.tsx:

Copynano client/src/pages/Projects.tsx
Find lines 241 and 247, add the same options:

Copy  // Fetch user's favorite project IDs (Phase 3.4)
  const { data: favoriteProjectIds = [] } = useQuery<string[]>({
    queryKey: ['/api/user/favorite-projects'],
    enabled: isOnline,
    refetchOnMount: false,  // âœ… ADD THIS
    refetchOnReconnect: false,  // âœ… ADD THIS
  });

  // Fetch user's recent project IDs (Phase 3.4)
  const { data: recentProjectIds = [] } = useQuery<string[]>({
    queryKey: ['/api/user/recent-projects'],
    enabled: isOnline,
    refetchOnMount: false,  // âœ… ADD THIS
    refetchOnReconnect: false,  // âœ… ADD THIS
  });
ðŸ“¤ Deploy the Fixes
Copy# In Replit Shell
npm run build
git add .
git commit -m "Fix: Prevent infinite network loop - memoize OfflineIndicator, stabilize redirects, dedupe queries"
git push origin main
Then on your Mac:

Copycd ~/Documents/Projects/FieldSnaps
git pull origin main
npm run build
npx cap sync ios
npx cap open ios
In Xcode:

Product â†’ Clean Build Folder
Delete app from simulator
Product â†’ Run
âœ… Expected Results
After this fix:

âœ… App loads in 1-2 seconds
âœ… ZERO network spam (normal behavior: 1-2 calls on load, then stops)
âœ… No more infinite loop
âœ… Projects page loads immediately
âœ… Login persists
âœ… Smooth navigation
