Last login: Fri Dec 26 17:07:10 on ttys000
bearmac@Alexs-MacBook-Pro-2 ~ % cd ~/Documents/Projects/FieldSnaps
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % grep "pbfuwfzccdmpkmhncyjg" dist/assets/*.js && echo "âœ… FOUND" || echo "âŒ NOT FOUND"
zsh: no matches found: dist/assets/*.js
âŒ NOT FOUND
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % ls -la .env.local
-rw-r--r--  1 bearmac  staff  498 Dec 26 16:59 .env.local
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % ls -la client/.env.local
ls: client/.env.local: No such file or directory
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % cp .env.local client/.env.local
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % npm run build

> rest-express@1.0.1 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.20 building for production...
transforming (1) index.html[baseline-browser-mapping] The data in this module is over two months old.  To ensure accurate Baseline data, please update: `npm i baseline-browser-mapping@latest -D`
transforming (9) src/lib/nativeSplashScreen.ts
A PostCSS plugin did not pass the `from` option to `postcss.parse`. This may cause imported assets to be incorrectly transformed. If you've recently added a PostCSS plugin that raised this warning, please contact the package author to fix the issue.
âœ“ 3267 modules transformed.
../dist/public/index.html                                                 2.48 kB â”‚ gzip:   0.92 kB
../dist/public/assets/photoCompression.worker-Dqm7FVON.js                 2.54 kB
../dist/public/assets/Fieldsnap logo v1.2_1760310501545-reWcQgwu.png    294.95 kB
../dist/public/assets/IMG_3762_1762447489193-BUUS8a5E.png               696.18 kB
../dist/public/assets/camera-roll-mixed-photos-3pVvTezs.png           4,934.62 kB
../dist/public/assets/index-BuEkCcik.css                                131.49 kB â”‚ gzip:  20.45 kB
../dist/public/assets/web-5ImO28D9.js                                     0.12 kB â”‚ gzip:   0.13 kB
../dist/public/assets/web-CosUr4Jc.js                                     0.29 kB â”‚ gzip:   0.21 kB
../dist/public/assets/web-UaCg1QFy.js                                     0.35 kB â”‚ gzip:   0.19 kB
../dist/public/assets/web-w5dhnh0m.js                                     0.36 kB â”‚ gzip:   0.25 kB
../dist/public/assets/web-Bm8ZH7lY.js                                     0.38 kB â”‚ gzip:   0.25 kB
../dist/public/assets/web-W8jRAwUg.js                                     0.39 kB â”‚ gzip:   0.28 kB
../dist/public/assets/grid-3x3-B2OGTaMk.js                                0.46 kB â”‚ gzip:   0.31 kB
../dist/public/assets/tag-BYhaFGcT.js                                     0.50 kB â”‚ gzip:   0.35 kB
../dist/public/assets/subDays-DbSY7OgR.js                                 0.67 kB â”‚ gzip:   0.35 kB
../dist/public/assets/native-Bynh6dt6.js                                  0.75 kB â”‚ gzip:   0.35 kB
../dist/public/assets/web-DxAGRpt9.js                                     0.76 kB â”‚ gzip:   0.35 kB
../dist/public/assets/videoUtils-FQGJR9l4.js                              0.77 kB â”‚ gzip:   0.45 kB
../dist/public/assets/web-d9fY0uNx.js                                     0.80 kB â”‚ gzip:   0.41 kB
../dist/public/assets/web-D4WFgM1I.js                                     0.80 kB â”‚ gzip:   0.24 kB
../dist/public/assets/web-CP2VwE6B.js                                     0.94 kB â”‚ gzip:   0.47 kB
../dist/public/assets/web-3rHVVoze.js                                     1.15 kB â”‚ gzip:   0.55 kB
../dist/public/assets/web-Cu3aHt68.js                                     1.25 kB â”‚ gzip:   0.58 kB
../dist/public/assets/base-CkTJDosp.js                                    2.53 kB â”‚ gzip:   0.93 kB
../dist/public/assets/web-CwBNbU7P.js                                     2.97 kB â”‚ gzip:   0.82 kB
../dist/public/assets/web-ByS6iot9.js                                     3.44 kB â”‚ gzip:   1.09 kB
../dist/public/assets/web-_goiufkQ.js                                     8.86 kB â”‚ gzip:   3.05 kB
../dist/public/assets/toaster-ncwDswOz.js                                13.73 kB â”‚ gzip:   4.86 kB
../dist/public/assets/purify.es-sOfw8HaZ.js                              22.67 kB â”‚ gzip:   8.79 kB
../dist/public/assets/web-CoLLEOHU.js                                    23.59 kB â”‚ gzip:   6.70 kB
../dist/public/assets/Settings-Dpa-eKtx.js                               43.40 kB â”‚ gzip:   9.60 kB
../dist/public/assets/ToDos-Dp-5hsFn.js                                  50.77 kB â”‚ gzip:  12.95 kB
../dist/public/assets/Camera-DA4kOvx8.js                                 78.78 kB â”‚ gzip:  21.37 kB
../dist/public/assets/ProjectPhotos-Da4fFrFq.js                         125.57 kB â”‚ gzip:  36.80 kB
../dist/public/assets/index.es-DQeHkZo8.js                              150.57 kB â”‚ gzip:  51.50 kB
../dist/public/assets/html2canvas.esm-CBrSDip1.js                       201.42 kB â”‚ gzip:  48.03 kB
../dist/public/assets/index-DcnuVavB.js                               1,696.48 kB â”‚ gzip: 491.92 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
âœ“ built in 3.58s

  dist/index.js  309.8kb

âš¡ Done in 13ms
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % grep "pbfuwfzccdmpkmhncyjg" dist/assets/*.js && echo "âœ… FOUND" || echo "âŒ NOT FOUND"
zsh: no matches found: dist/assets/*.js
âŒ NOT FOUND
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % npx cap sync ios
ðŸ”§ Configuring dynamic provider dependencies for SocialLogin

Provider configuration:
  âœ” Google: enabled
  âœ” Facebook: enabled
  âœ” Apple: enabled
  âœ” Twitter: enabled

â„¹ Configuring iOS dependencies...
â„¹ Podspec already up to date
âœ” Configuration complete

âœ” Copying web assets from public to ios/App/App/public in 10.55ms
âœ” Creating capacitor.config.json in ios/App/App in 475.21Î¼s
âœ” copy ios in 76.50ms
âœ” Updating iOS plugins in 7.50ms
âœ” Updating iOS native dependencies with pod install in 2.22s
[info] Found 26 Capacitor plugins for ios:
       @aparajita/capacitor-secure-storage@7.1.3
       @capacitor-community/generic-oauth2@7.0.0
       @capacitor-community/speech-recognition@7.0.1
       @capacitor/action-sheet@7.0.2
       @capacitor/app@7.1.0
       @capacitor/browser@7.0.2
       @capacitor/camera@7.0.2
       @capacitor/clipboard@7.0.2
       @capacitor/device@7.0.2
       @capacitor/dialog@7.0.2
       @capacitor/filesystem@7.1.4
       @capacitor/geolocation@7.1.5
       @capacitor/haptics@7.0.2
       @capacitor/keyboard@7.0.3
       @capacitor/local-notifications@7.0.3
       @capacitor/network@7.0.2
       @capacitor/preferences@7.0.2
       @capacitor/share@7.0.2
       @capacitor/splash-screen@7.0.3
       @capacitor/status-bar@7.0.3
       @capacitor/toast@7.0.2
       @capgo/capacitor-social-login@7.20.0
       @capgo/capacitor-updater@7.22.0
       @transistorsoft/capacitor-background-fetch@7.1.0
       @transistorsoft/capacitor-background-geolocation@7.2.4
       capacitor-native-settings@7.0.2
âœ” update ios in 2.27s
[info] Sync finished in 2.595s
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % grep "pbfuwfzccdmpkmhncyjg" dist/public/assets/*.js && echo "âœ… FOUND" || echo "âŒ NOT FOUND"
dist/public/assets/index-DcnuVavB.js:`);const I=await k.signMessage(new TextEncoder().encode(y),"utf8");if(!I||!(I instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");g=I}}try{const{data:w,error:v}=await Vt(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:y,signature:ed(g)},!((f=t.options)===null||f===void 0)&&f.captchaToken?{gotrue_meta_security:{captcha_token:(p=t.options)===null||p===void 0?void 0:p.captchaToken}}:null),xform:Ta});if(v)throw v;if(!w||!w.session||!w.user){const x=new _h;return this._returnResult({data:{user:null,session:null},error:x})}return w.session&&(await this._saveSession(w.session),await this._notifyAllSubscribers("SIGNED_IN",w.session)),this._returnResult({data:Object.assign({},w),error:v})}catch(w){if(Ft(w))return this._returnResult({data:{user:null,session:null},error:w});throw w}}async _exchangeCodeForSession(t){const n=await Mu(this.storage,`${this.storageKey}-code-verifier`),[r,s]=(n??"").split("/");try{const{data:i,error:a}=await Vt(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:t,code_verifier:r},xform:Ta});if(await Xl(this.storage,`${this.storageKey}-code-verifier`),a)throw a;if(!i||!i.session||!i.user){const o=new _h;return this._returnResult({data:{user:null,session:null,redirectType:null},error:o})}return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),this._returnResult({data:Object.assign(Object.assign({},i),{redirectType:s??null}),error:a})}catch(i){if(Ft(i))return this._returnResult({data:{user:null,session:null,redirectType:null},error:i});throw i}}async signInWithIdToken(t){try{const{options:n,provider:r,token:s,access_token:i,nonce:a}=t,o=await Vt(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:s,access_token:i,nonce:a,gotrue_meta_security:{captcha_token:n==null?void 0:n.captchaToken}},xform:Ta}),{data:c,error:u}=o;if(u)return this._returnResult({data:{user:null,session:null},error:u});if(!c||!c.session||!c.user){const d=new _h;return this._returnResult({data:{user:null,session:null},error:d})}return c.session&&(await this._saveSession(c.session),await this._notifyAllSubscribers("SIGNED_IN",c.session)),this._returnResult({data:c,error:u})}catch(n){if(Ft(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithOtp(t){var n,r,s,i,a;try{if("email"in t){const{email:o,options:c}=t;let u=null,d=null;this.flowType==="pkce"&&([u,d]=await Sh(this.storage,this.storageKey));const{error:h}=await Vt(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(n=c==null?void 0:c.data)!==null&&n!==void 0?n:{},create_user:(r=c==null?void 0:c.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},code_challenge:u,code_challenge_method:d},redirectTo:c==null?void 0:c.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:h})}if("phone"in t){const{phone:o,options:c}=t,{data:u,error:d}=await Vt(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(s=c==null?void 0:c.data)!==null&&s!==void 0?s:{},create_user:(i=c==null?void 0:c.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},channel:(a=c==null?void 0:c.channel)!==null&&a!==void 0?a:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:u==null?void 0:u.message_id},error:d})}throw new Yv("You must provide either an email or phone number.")}catch(o){if(Ft(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async verifyOtp(t){var n,r;try{let s,i;"options"in t&&(s=(n=t.options)===null||n===void 0?void 0:n.redirectTo,i=(r=t.options)===null||r===void 0?void 0:r.captchaToken);const{data:a,error:o}=await Vt(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},t),{gotrue_meta_security:{captcha_token:i}}),redirectTo:s,xform:Ta});if(o)throw o;if(!a)throw new Error("An error occurred on token verification.");const c=a.session,u=a.user;return c!=null&&c.access_token&&(await this._saveSession(c),await this._notifyAllSubscribers(t.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",c)),this._returnResult({data:{user:u,session:c},error:null})}catch(s){if(Ft(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithSSO(t){var n,r,s,i,a;try{let o=null,c=null;this.flowType==="pkce"&&([o,c]=await Sh(this.storage,this.storageKey));const u=await Vt(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in t?{provider_id:t.providerId}:null),"domain"in t?{domain:t.domain}:null),{redirect_to:(r=(n=t.options)===null||n===void 0?void 0:n.redirectTo)!==null&&r!==void 0?r:void 0}),!((s=t==null?void 0:t.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:t.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:o,code_challenge_method:c}),headers:this.headers,xform:jH});return!((i=u.data)===null||i===void 0)&&i.url&&As()&&!(!((a=t.options)===null||a===void 0)&&a.skipBrowserRedirect)&&window.location.assign(u.data.url),this._returnResult(u)}catch(o){if(Ft(o))return this._returnResult({data:null,error:o});throw o}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async t=>{const{data:{session:n},error:r}=t;if(r)throw r;if(!n)throw new Mi;const{error:s}=await Vt(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:n.access_token});return this._returnResult({data:{user:null,session:null},error:s})})}catch(t){if(Ft(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async resend(t){try{const n=`${this.url}/resend`;if("email"in t){const{email:r,type:s,options:i}=t,{error:a}=await Vt(this.fetch,"POST",n,{headers:this.headers,body:{email:r,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},redirectTo:i==null?void 0:i.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:a})}else if("phone"in t){const{phone:r,type:s,options:i}=t,{data:a,error:o}=await Vt(this.fetch,"POST",n,{headers:this.headers,body:{phone:r,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:a==null?void 0:a.message_id},error:o})}throw new Yv("You must provide either an email or phone number and a type")}catch(n){if(Ft(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async n=>n))}async _acquireLock(t,n){this._debug("#_acquireLock","begin",t);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await r,await n()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,t,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=n();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(t){this._debug("#_useSession","begin");try{const n=await this.__loadSession();return await t(n)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let t=null;const n=await Mu(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",n),n!==null&&(this._isValidSession(n)?t=n:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!t)return{data:{session:null},error:null};const r=t.expires_at?t.expires_at*1e3-Date.now()<Bb:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",t.expires_at),!r){if(this.userStorage){const a=await Mu(this.userStorage,this.storageKey+"-user");a!=null&&a.user?t.user=a.user:t.user=qb()}if(this.storage.isServer&&t.user&&!t.user.__isUserNotAvailableProxy){const a={value:this.suppressGetSessionWarning};t.user=_H(t.user,a),a.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:t},error:null}}const{data:s,error:i}=await this._callRefreshToken(t.refresh_token);return i?this._returnResult({data:{session:null},error:i}):this._returnResult({data:{session:s},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(t){return t?await this._getUser(t):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(t){try{return t?await Vt(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:t,xform:vc}):await this._useSession(async n=>{var r,s,i;const{data:a,error:o}=n;if(o)throw o;return!(!((r=a.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Mi}:await Vt(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(s=a.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0,xform:vc})})}catch(n){if(Ft(n))return eH(n)&&(await this._removeSession(),await Xl(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:n});throw n}}async updateUser(t,n={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(t,n))}async _updateUser(t,n={}){try{return await this._useSession(async r=>{const{data:s,error:i}=r;if(i)throw i;if(!s.session)throw new Mi;const a=s.session;let o=null,c=null;this.flowType==="pkce"&&t.email!=null&&([o,c]=await Sh(this.storage,this.storageKey));const{data:u,error:d}=await Vt(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:n==null?void 0:n.emailRedirectTo,body:Object.assign(Object.assign({},t),{code_challenge:o,code_challenge_method:c}),jwt:a.access_token,xform:vc});if(d)throw d;return a.user=u.user,await this._saveSession(a),await this._notifyAllSubscribers("USER_UPDATED",a),this._returnResult({data:{user:a.user},error:null})})}catch(r){if(Ft(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(t){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(t))}async _setSession(t){try{if(!t.access_token||!t.refresh_token)throw new Mi;const n=Date.now()/1e3;let r=n,s=!0,i=null;const{payload:a}=Wb(t.access_token);if(a.exp&&(r=a.exp,s=r<=n),s){const{data:o,error:c}=await this._callRefreshToken(t.refresh_token);if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!o)return{data:{user:null,session:null},error:null};i=o}else{const{data:o,error:c}=await this._getUser(t.access_token);if(c)throw c;i={access_token:t.access_token,refresh_token:t.refresh_token,user:o.user,token_type:"bearer",expires_in:r-n,expires_at:r},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return this._returnResult({data:{user:i.user,session:i},error:null})}catch(n){if(Ft(n))return this._returnResult({data:{session:null,user:null},error:n});throw n}}async refreshSession(t){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(t))}async _refreshSession(t){try{return await this._useSession(async n=>{var r;if(!t){const{data:a,error:o}=n;if(o)throw o;t=(r=a.session)!==null&&r!==void 0?r:void 0}if(!(t!=null&&t.refresh_token))throw new Mi;const{data:s,error:i}=await this._callRefreshToken(t.refresh_token);return i?this._returnResult({data:{user:null,session:null},error:i}):s?this._returnResult({data:{user:s.user,session:s},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(n){if(Ft(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async _getSessionFromURL(t,n){try{if(!As())throw new Zv("No browser detected.");if(t.error||t.error_description||t.error_code)throw new Zv(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});switch(n){case"implicit":if(this.flowType==="pkce")throw new QA("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Zv("Not a valid implicit grant flow url.");break;default:}if(n==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!t.code)throw new QA("No code detected.");const{data:x,error:S}=await this._exchangeCodeForSession(t.code);if(S)throw S;const k=new URL(window.location.href);return k.searchParams.delete("code"),window.history.replaceState(window.history.state,"",k.toString()),{data:{session:x.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:s,access_token:i,refresh_token:a,expires_in:o,expires_at:c,token_type:u}=t;if(!i||!o||!a||!u)throw new Zv("No session defined in URL");const d=Math.round(Date.now()/1e3),h=parseInt(o);let f=d+h;c&&(f=parseInt(c));const p=f-d;p*1e3<=Mh&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${p}s, should have been closer to ${h}s`);const y=f-h;d-y>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",y,f,d):d-y<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",y,f,d);const{data:g,error:w}=await this._getUser(i);if(w)throw w;const v={provider_token:r,provider_refresh_token:s,access_token:i,expires_in:h,expires_at:f,refresh_token:a,token_type:u,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:v,redirectType:t.type},error:null})}catch(r){if(Ft(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(t){return!!(t.access_token||t.error_description)}async _isPKCECallback(t){const n=await Mu(this.storage,`${this.storageKey}-code-verifier`);return!!(t.code&&n)}async signOut(t={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(t))}async _signOut({scope:t}={scope:"global"}){return await this._useSession(async n=>{var r;const{data:s,error:i}=n;if(i)return this._returnResult({error:i});const a=(r=s.session)===null||r===void 0?void 0:r.access_token;if(a){const{error:o}=await this.admin.signOut(a,t);if(o&&!(Xq(o)&&(o.status===404||o.status===401||o.status===403)))return this._returnResult({error:o})}return t!=="others"&&(await this._removeSession(),await Xl(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(t){const n=lH(),r={id:n,callback:t,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",n),this.stateChangeEmitters.delete(n)}};return this._debug("#onAuthStateChange()","registered callback with id",n),this.stateChangeEmitters.set(n,r),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(n)})))(),{data:{subscription:r}}}async _emitInitialSession(t){return await this._useSession(async n=>{var r,s;try{const{data:{session:i},error:a}=n;if(a)throw a;await((r=this.stateChangeEmitters.get(t))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",t,"session",i)}catch(i){await((s=this.stateChangeEmitters.get(t))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",t,"error",i),console.error(i)}})}async resetPasswordForEmail(t,n={}){let r=null,s=null;this.flowType==="pkce"&&([r,s]=await Sh(this.storage,this.storageKey,!0));try{return await Vt(this.fetch,"POST",`${this.url}/recover`,{body:{email:t,code_challenge:r,code_challenge_method:s,gotrue_meta_security:{captcha_token:n.captchaToken}},headers:this.headers,redirectTo:n.redirectTo})}catch(i){if(Ft(i))return this._returnResult({data:null,error:i});throw i}}async getUserIdentities(){var t;try{const{data:n,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(t=n.user.identities)!==null&&t!==void 0?t:[]},error:null})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}}async linkIdentity(t){return"token"in t?this.linkIdentityIdToken(t):this.linkIdentityOAuth(t)}async linkIdentityOAuth(t){var n;try{const{data:r,error:s}=await this._useSession(async i=>{var a,o,c,u,d;const{data:h,error:f}=i;if(f)throw f;const p=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,t.provider,{redirectTo:(a=t.options)===null||a===void 0?void 0:a.redirectTo,scopes:(o=t.options)===null||o===void 0?void 0:o.scopes,queryParams:(c=t.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:!0});return await Vt(this.fetch,"GET",p,{headers:this.headers,jwt:(d=(u=h.session)===null||u===void 0?void 0:u.access_token)!==null&&d!==void 0?d:void 0})});if(s)throw s;return As()&&!(!((n=t.options)===null||n===void 0)&&n.skipBrowserRedirect)&&window.location.assign(r==null?void 0:r.url),this._returnResult({data:{provider:t.provider,url:r==null?void 0:r.url},error:null})}catch(r){if(Ft(r))return this._returnResult({data:{provider:t.provider,url:null},error:r});throw r}}async linkIdentityIdToken(t){return await this._useSession(async n=>{var r;try{const{error:s,data:{session:i}}=n;if(s)throw s;const{options:a,provider:o,token:c,access_token:u,nonce:d}=t,h=await Vt(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=i==null?void 0:i.access_token)!==null&&r!==void 0?r:void 0,body:{provider:o,id_token:c,access_token:u,nonce:d,link_identity:!0,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Ta}),{data:f,error:p}=h;return p?this._returnResult({data:{user:null,session:null},error:p}):!f||!f.session||!f.user?this._returnResult({data:{user:null,session:null},error:new _h}):(f.session&&(await this._saveSession(f.session),await this._notifyAllSubscribers("USER_UPDATED",f.session)),this._returnResult({data:f,error:p}))}catch(s){if(Ft(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}})}async unlinkIdentity(t){try{return await this._useSession(async n=>{var r,s;const{data:i,error:a}=n;if(a)throw a;return await Vt(this.fetch,"DELETE",`${this.url}/user/identities/${t.identity_id}`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0})})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}}async _refreshAccessToken(t){const n=`#_refreshAccessToken(${t.substring(0,5)}...)`;this._debug(n,"begin");try{const r=Date.now();return await hH(async s=>(s>0&&await dH(200*Math.pow(2,s-1)),this._debug(n,"refreshing attempt",s),await Vt(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:t},headers:this.headers,xform:Ta})),(s,i)=>{const a=200*Math.pow(2,s);return i&&zb(i)&&Date.now()+a-r<Mh})}catch(r){if(this._debug(n,"error",r),Ft(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(n,"end")}}_isValidSession(t){return typeof t=="object"&&t!==null&&"access_token"in t&&"refresh_token"in t&&"expires_at"in t}async _handleProviderSignIn(t,n){const r=await this._getUrlForProvider(`${this.url}/authorize`,t,{redirectTo:n.redirectTo,scopes:n.scopes,queryParams:n.queryParams});return this._debug("#_handleProviderSignIn()","provider",t,"options",n,"url",r),As()&&!n.skipBrowserRedirect&&window.location.assign(r),{data:{provider:t,url:r},error:null}}async _recoverAndRefresh(){var t,n;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const s=await Mu(this.storage,this.storageKey);if(s&&this.userStorage){let a=await Mu(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!a&&(a={user:s.user},await Fh(this.userStorage,this.storageKey+"-user",a)),s.user=(t=a==null?void 0:a.user)!==null&&t!==void 0?t:qb()}else if(s&&!s.user&&!s.user){const a=await Mu(this.storage,this.storageKey+"-user");a&&(a!=null&&a.user)?(s.user=a.user,await Xl(this.storage,this.storageKey+"-user"),await Fh(this.storage,this.storageKey,s)):s.user=qb()}if(this._debug(r,"session from storage",s),!this._isValidSession(s)){this._debug(r,"session is not valid"),s!==null&&await this._removeSession();return}const i=((n=s.expires_at)!==null&&n!==void 0?n:1/0)*1e3-Date.now()<Bb;if(this._debug(r,`session has${i?"":" not"} expired with margin of ${Bb}s`),i){if(this.autoRefreshToken&&s.refresh_token){const{error:a}=await this._callRefreshToken(s.refresh_token);a&&(console.error(a),zb(a)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",a),await this._removeSession()))}}else if(s.user&&s.user.__isUserNotAvailableProxy===!0)try{const{data:a,error:o}=await this._getUser(s.access_token);!o&&(a!=null&&a.user)?(s.user=a.user,await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(a){console.error("Error getting user data:",a),this._debug(r,"error getting user data, skipping SIGNED_IN notification",a)}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(r,"error",s),console.error(s);return}finally{this._debug(r,"end")}}async _callRefreshToken(t){var n,r;if(!t)throw new Mi;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${t.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new zw;const{data:i,error:a}=await this._refreshAccessToken(t);if(a)throw a;if(!i.session)throw new Mi;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const o={data:i.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(i){if(this._debug(s,"error",i),Ft(i)){const a={data:null,error:i};return zb(i)||await this._removeSession(),(n=this.refreshingDeferred)===null||n===void 0||n.resolve(a),a}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(i),i}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(t,n,r=!0){const s=`#_notifyAllSubscribers(${t})`;this._debug(s,"begin",n,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:t,session:n});const i=[],a=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(t,n)}catch(c){i.push(c)}});if(await Promise.all(a),i.length>0){for(let o=0;o<i.length;o+=1)console.error(i[o]);throw i[0]}}finally{this._debug(s,"end")}}async _saveSession(t){this._debug("#_saveSession()",t),this.suppressGetSessionWarning=!0;const n=Object.assign({},t),r=n.user&&n.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&n.user&&await Fh(this.userStorage,this.storageKey+"-user",{user:n.user});const s=Object.assign({},n);delete s.user;const i=rC(s);await Fh(this.storage,this.storageKey,i)}else{const s=rC(n);await Fh(this.storage,this.storageKey,s)}}async _removeSession(){this._debug("#_removeSession()"),await Xl(this.storage,this.storageKey),await Xl(this.storage,this.storageKey+"-code-verifier"),await Xl(this.storage,this.storageKey+"-user"),this.userStorage&&await Xl(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const t=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{t&&As()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",t)}catch(n){console.error("removing visibilitychange callback failed",n)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const t=setInterval(()=>this._autoRefreshTokenTick(),Mh);this.autoRefreshTicker=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const t=this.autoRefreshTicker;this.autoRefreshTicker=null,t&&clearInterval(t)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const t=Date.now();try{return await this._useSession(async n=>{const{data:{session:r}}=n;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((r.expires_at*1e3-t)/Mh);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${Mh}ms, refresh threshold is ${N_} ticks`),s<=N_&&await this._callRefreshToken(r.refresh_token)})}catch(n){console.error("Auto refresh tick failed with error. This is likely a transient error.",n)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(t){if(t.isAcquireTimeout||t instanceof MR)this._debug("auto refresh token tick lock not available");else throw t}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!As()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(t){console.error("_handleVisibilityChange",t)}}async _onVisibilityChanged(t){const n=`#_onVisibilityChanged(${t})`;this._debug(n,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),t||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(n,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(t,n,r){const s=[`provider=${encodeURIComponent(n)}`];if(r!=null&&r.redirectTo&&s.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r!=null&&r.scopes&&s.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[i,a]=await Sh(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(a)}`});s.push(o.toString())}if(r!=null&&r.queryParams){const i=new URLSearchParams(r.queryParams);s.push(i.toString())}return r!=null&&r.skipBrowserRedirect&&s.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${t}?${s.join("&")}`}async _unenroll(t){try{return await this._useSession(async n=>{var r;const{data:s,error:i}=n;return i?this._returnResult({data:null,error:i}):await Vt(this.fetch,"DELETE",`${this.url}/factors/${t.factorId}`,{headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token})})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}}async _enroll(t){try{return await this._useSession(async n=>{var r,s;const{data:i,error:a}=n;if(a)return this._returnResult({data:null,error:a});const o=Object.assign({friendly_name:t.friendlyName,factor_type:t.factorType},t.factorType==="phone"?{phone:t.phone}:t.factorType==="totp"?{issuer:t.issuer}:{}),{data:c,error:u}=await Vt(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});return u?this._returnResult({data:null,error:u}):(t.factorType==="totp"&&c.type==="totp"&&(!((s=c==null?void 0:c.totp)===null||s===void 0)&&s.qr_code)&&(c.totp.qr_code=`data:image/svg+xml;utf-8,${c.totp.qr_code}`),this._returnResult({data:c,error:null}))})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}}async _verify(t){return this._acquireLock(-1,async()=>{try{return await this._useSession(async n=>{var r;const{data:s,error:i}=n;if(i)return this._returnResult({data:null,error:i});const a=Object.assign({challenge_id:t.challengeId},"webauthn"in t?{webauthn:Object.assign(Object.assign({},t.webauthn),{credential_response:t.webauthn.type==="create"?zH(t.webauthn.credential_response):WH(t.webauthn.credential_response)})}:{code:t.code}),{data:o,error:c}=await Vt(this.fetch,"POST",`${this.url}/factors/${t.factorId}/verify`,{body:a,headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token});return c?this._returnResult({data:null,error:c}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),this._returnResult({data:o,error:c}))})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}})}async _challenge(t){return this._acquireLock(-1,async()=>{try{return await this._useSession(async n=>{var r;const{data:s,error:i}=n;if(i)return this._returnResult({data:null,error:i});const a=await Vt(this.fetch,"POST",`${this.url}/factors/${t.factorId}/challenge`,{body:t,headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token});if(a.error)return a;const{data:o}=a;if(o.type!=="webauthn")return{data:o,error:null};switch(o.webauthn.type){case"create":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:$H(o.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:BH(o.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}})}async _challengeAndVerify(t){const{data:n,error:r}=await this._challenge({factorId:t.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:t.factorId,challengeId:n.id,code:t.code})}async _listFactors(){var t;const{data:{user:n},error:r}=await this.getUser();if(r)return{data:null,error:r};const s={all:[],phone:[],totp:[],webauthn:[]};for(const i of(t=n==null?void 0:n.factors)!==null&&t!==void 0?t:[])s.all.push(i),i.status==="verified"&&s[i.factor_type].push(i);return{data:s,error:null}}async _getAuthenticatorAssuranceLevel(){var t,n;const{data:{session:r},error:s}=await this.getSession();if(s)return this._returnResult({data:null,error:s});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:i}=Wb(r.access_token);let a=null;i.aal&&(a=i.aal);let o=a;((n=(t=r.user.factors)===null||t===void 0?void 0:t.filter(d=>d.status==="verified"))!==null&&n!==void 0?n:[]).length>0&&(o="aal2");const u=i.amr||[];return{data:{currentLevel:a,nextLevel:o,currentAuthenticationMethods:u},error:null}}async _getAuthorizationDetails(t){try{return await this._useSession(async n=>{const{data:{session:r},error:s}=n;return s?this._returnResult({data:null,error:s}):r?await Vt(this.fetch,"GET",`${this.url}/oauth/authorizations/${t}`,{headers:this.headers,jwt:r.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new Mi})})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}}async _approveAuthorization(t,n){try{return await this._useSession(async r=>{const{data:{session:s},error:i}=r;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new Mi});const a=await Vt(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"approve"},xform:o=>({data:o,error:null})});return a.data&&a.data.redirect_url&&As()&&!(n!=null&&n.skipBrowserRedirect)&&window.location.assign(a.data.redirect_url),a})}catch(r){if(Ft(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(t,n){try{return await this._useSession(async r=>{const{data:{session:s},error:i}=r;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new Mi});const a=await Vt(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"deny"},xform:o=>({data:o,error:null})});return a.data&&a.data.redirect_url&&As()&&!(n!=null&&n.skipBrowserRedirect)&&window.location.assign(a.data.redirect_url),a})}catch(r){if(Ft(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async t=>{const{data:{session:n},error:r}=t;return r?this._returnResult({data:null,error:r}):n?await Vt(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:n.access_token,xform:s=>({data:s,error:null})}):this._returnResult({data:null,error:new Mi})})}catch(t){if(Ft(t))return this._returnResult({data:null,error:t});throw t}}async _revokeOAuthGrant(t){try{return await this._useSession(async n=>{const{data:{session:r},error:s}=n;return s?this._returnResult({data:null,error:s}):r?(await Vt(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:t.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new Mi})})}catch(n){if(Ft(n))return this._returnResult({data:null,error:n});throw n}}async fetchJwk(t,n={keys:[]}){let r=n.keys.find(o=>o.kid===t);if(r)return r;const s=Date.now();if(r=this.jwks.keys.find(o=>o.kid===t),r&&this.jwks_cached_at+Jq>s)return r;const{data:i,error:a}=await Vt(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(a)throw a;return!i.keys||i.keys.length===0||(this.jwks=i,this.jwks_cached_at=s,r=i.keys.find(o=>o.kid===t),!r)?null:r}async getClaims(t,n={}){try{let r=t;if(!r){const{data:p,error:y}=await this.getSession();if(y||!p.session)return this._returnResult({data:null,error:y});r=p.session.access_token}const{header:s,payload:i,signature:a,raw:{header:o,payload:c}}=Wb(r);n!=null&&n.allowExpired||wH(i.exp);const u=!s.alg||s.alg.startsWith("HS")||!s.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(s.kid,n!=null&&n.keys?{keys:n.keys}:n==null?void 0:n.jwks);if(!u){const{error:p}=await this.getUser(r);if(p)throw p;return{data:{claims:i,header:s,signature:a},error:null}}const d=xH(s.alg),h=await crypto.subtle.importKey("jwk",u,d,!0,["verify"]);if(!await crypto.subtle.verify(d,h,a,aH(`${o}.${c}`)))throw new A_("Invalid JWT signature");return{data:{claims:i,header:s,signature:a},error:null}}catch(r){if(Ft(r))return this._returnResult({data:null,error:r});throw r}}}Fg.nextInstanceID={};const QH=Fg;class XH extends QH{constructor(t){super(t)}}class eV{constructor(t,n,r){var s,i,a;this.supabaseUrl=t,this.supabaseKey=n;const o=Vq(t);if(!n)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const c=`sb-${o.hostname.split(".")[0]}-auth-token`,u={db:Fq,realtime:$q,auth:Object.assign(Object.assign({},Uq),{storageKey:c}),global:Mq},d=Hq(r??{},u);this.storageKey=(s=d.auth.storageKey)!==null&&s!==void 0?s:"",this.headers=(i=d.global.headers)!==null&&i!==void 0?i:{},d.accessToken?(this.accessToken=d.accessToken,this.auth=new Proxy({},{get:(h,f)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(f)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((a=d.auth)!==null&&a!==void 0?a:{},this.headers,d.global.fetch),this.fetch=Wq(n,this._getAccessToken.bind(this),d.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},d.realtime)),this.accessToken&&this.accessToken().then(h=>this.realtime.setAuth(h)).catch(h=>console.warn("Failed to set initial Realtime auth token:",h)),this.rest=new $W(new URL("rest/v1",o).href,{headers:this.headers,schema:d.db.schema,fetch:this.fetch}),this.storage=new Rq(this.storageUrl.href,this.headers,this.fetch,r==null?void 0:r.storage),d.accessToken||this._listenForAuthEvents()}get functions(){return new MW(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(t){return this.rest.from(t)}schema(t){return this.rest.schema(t)}rpc(t,n={},r={head:!1,get:!1,count:void 0}){return this.rest.rpc(t,n,r)}channel(t,n={config:{}}){return this.realtime.channel(t,n)}getChannels(){return this.realtime.getChannels()}removeChannel(t){return this.realtime.removeChannel(t)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var t,n;if(this.accessToken)return await this.accessToken();const{data:r}=await this.auth.getSession();return(n=(t=r.session)===null||t===void 0?void 0:t.access_token)!==null&&n!==void 0?n:this.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:t,persistSession:n,detectSessionInUrl:r,storage:s,userStorage:i,storageKey:a,flowType:o,lock:c,debug:u,throwOnError:d},h,f){const p={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new XH({url:this.authUrl.href,headers:Object.assign(Object.assign({},p),h),storageKey:a,autoRefreshToken:t,persistSession:n,detectSessionInUrl:r,storage:s,userStorage:i,flowType:o,lock:c,debug:u,throwOnError:d,fetch:f,hasCustomAuthorizationHeader:Object.keys(this.headers).some(y=>y.toLowerCase()==="authorization")})}_initRealtimeClient(t){return new rq(this.realtimeUrl.href,Object.assign(Object.assign({},t),{params:Object.assign({apikey:this.supabaseKey},t==null?void 0:t.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((n,r)=>{this._handleTokenChanged(n,"CLIENT",r==null?void 0:r.access_token)})}_handleTokenChanged(t,n,r){(t==="TOKEN_REFRESHED"||t==="SIGNED_IN")&&this.changedAccessToken!==r?(this.changedAccessToken=r,this.realtime.setAuth(r)):t==="SIGNED_OUT"&&(this.realtime.setAuth(),n=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const tV=(e,t,n)=>new eV(e,t,n);function nV(){if(typeof window<"u"||typeof process>"u")return!1;const e=process.version;if(e==null)return!1;const t=e.match(/^v(\d+)\./);return t?parseInt(t[1],10)<=18:!1}nV()&&console.warn("âš ï¸  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const rV="https://pbfuwfzccdmpkmhncyjg.supabase.co",sV="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZnV3ZnpjY2RtcGttaG5jeWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTA3NTcsImV4cCI6MjA3OTc2Njc1N30.zMNbgQpyQWRJMBfaz5W25JYjwf5Zn6bRIzuq_9Rx1gs",um=new Map;function iV(){try{const e=Ut.getPlatform(),t=e!=="web";return console.log(`[Supabase] Platform check: ${e}, isNative: ${t}`),t}catch{return console.log("[Supabase] Platform check failed, assuming web"),!1}}async function aV(e){var t;try{const n=await ua.get(e);if(!n)return null;let r;return typeof n=="object"&&"data"in n?r=n.data:r=n,r?typeof r=="string"&&r.startsWith('"')&&r.endsWith('"')?JSON.parse(r):r:null}catch{return console.log("[Supabase Storage] SecureStorage get failed, falling back to localStorage"),((t=window.localStorage)==null?void 0:t.getItem(e))??null}}async function oV(e,t){try{await ua.set(e,t),typeof window<"u"&&window.localStorage.setItem(e,t)}catch{console.log("[Supabase Storage] SecureStorage set failed, using localStorage"),typeof window<"u"&&window.localStorage.setItem(e,t)}}async function lV(e){try{await ua.remove(e),typeof window<"u"&&window.localStorage.removeItem(e)}catch{console.log("[Supabase Storage] SecureStorage remove failed, using localStorage"),typeof window<"u"&&window.localStorage.removeItem(e)}}const cV=iV(),ss=tV(rV,sV,{auth:{flowType:"pkce",detectSessionInUrl:!0,persistSession:!0,autoRefreshToken:!0,storage:cV?{getItem:async e=>{if(um.has(e))return um.get(e)??null;const t=await aV(e);return um.set(e,t),t},setItem:async(e,t)=>{um.set(e,t),await oV(e,t)},removeItem:async e=>{um.delete(e),await lV(e)}}:{getItem:e=>typeof window<"u"?window.localStorage.getItem(e):null,setItem:(e,t)=>{typeof window<"u"&&window.localStorage.setItem(e,t)},removeItem:e=>{typeof window<"u"&&window.localStorage.removeItem(e)}}}});function $R(){try{if(Ut.getPlatform()!=="web")return"com.fieldsnaps.app://auth/callback"}catch{}return`${window.location.origin}/auth/callback`}function Ww(){try{return Ut.getPlatform()!=="web"}catch{return!1}}const Jv="access_token",Vb="refresh_token";class BR{async storeTokens(t,n,r){try{console.log("[TokenManager] Storing tokens in iOS Keychain"),await ua.set(Jv,t),await ua.set(Vb,n),console.log("[TokenManager] âœ… Tokens stored successfully"),r&&console.log("[TokenManager] Access token expires in:",r,"seconds")}catch(s){throw console.error("[TokenManager] Failed to store tokens:",s),s}}async getAccessToken(){try{const t=await ua.get(Jv);if(!t)return null;let n;if(typeof t=="object"&&"data"in t?n=t.data:n=t,!n)return null;if(console.log("[TokenManager] Raw value from SecureStorage:",typeof n,typeof n=="string"?n.substring(0,50):n),typeof n=="string"&&n.startsWith('"')&&n.endsWith('"')){const r=JSON.parse(n);return console.log("[TokenManager] âœ… Unwrapped token (removed quotes):",typeof r,typeof r=="string"?r.substring(0,50):r),r}return console.log("[TokenManager] âœ… Returning clean token:",typeof n,typeof n=="string"?n.substring(0,50):n),n}catch{return console.log("[TokenManager] No access token found"),null}}async getRefreshToken(){try{const t=await ua.get(Vb);if(!t)return null;let n;return typeof t=="object"&&"data"in t?n=t.data:n=t,n?typeof n=="string"&&n.startsWith('"')&&n.endsWith('"')?JSON.parse(n):n:null}catch{return console.log("[TokenManager] No refresh token found"),null}}decodeAccessToken(t){try{const n=PW(t),r=Math.floor(Date.now()/1e3);return n.exp<r?(console.log("[TokenManager] Access token expired"),null):n}catch(n){return console.error("[TokenManager] Failed to decode token:",n),null}}async isAccessTokenValid(){const t=await this.getAccessToken();if(!t)return!1;const n=this.decodeAccessToken(t);if(!n)return!1;const r=Math.floor(Date.now()/1e3),s=n.exp>r+60;return console.log("[TokenManager] Access token valid:",s),s}async refreshAccessToken(){try{console.log("[TokenManager] Refreshing access token...");const t=await this.getRefreshToken();if(!t)return console.log("[TokenManager] No refresh token available"),null;const n=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t})});if(!n.ok)return console.error("[TokenManager] Failed to refresh token:",n.status),null;const r=n.headers.get("content-type");if(!r||!r.includes("application/json"))return console.error("[TokenManager] Unexpected response type:",r),console.error("[TokenManager] Response is not JSON - likely redirected to login page"),null;const i=(await n.json()).access_token;return await ua.set(Jv,i),console.log("[TokenManager] âœ… Access token refreshed successfully"),i}catch(t){return console.error("[TokenManager] Error refreshing token:",t),null}}async getSupabaseAccessToken(){try{const{data:{session:t},error:n}=await ss.auth.getSession();if(n)return console.error("[TokenManager] Error getting Supabase session:",n),null;if(!(t!=null&&t.access_token))return console.log("[TokenManager] No Supabase session found"),null;const r=Math.floor(Date.now()/1e3);if((t.expires_at||0)-r<60){console.log("[TokenManager] Supabase token expiring soon, refreshing...");const{data:{session:i},error:a}=await ss.auth.refreshSession();return a||!i?(console.error("[TokenManager] Failed to refresh Supabase session:",a),null):(console.log("[TokenManager] âœ… Supabase session refreshed"),i.access_token)}return t.access_token}catch(t){return console.error("[TokenManager] Error getting Supabase access token:",t),null}}async getValidAccessToken(){const t=await this.getSupabaseAccessToken();if(t)return t;if(await this.isAccessTokenValid())return this.getAccessToken();console.log("[TokenManager] Access token expired or expiring soon, refreshing...");const r=await this.refreshAccessToken();return r||(console.log("[TokenManager] âŒ Token refresh failed, user must login"),await this.clearTokens(),null)}async clearTokens(){try{console.log("[TokenManager] Clearing tokens from iOS Keychain"),await ua.remove(Jv),await ua.remove(Vb),console.log("[TokenManager] âœ… Tokens cleared")}catch(t){console.error("[TokenManager] Error clearing tokens:",t)}}async getUserInfo(){const t=await this.getAccessToken();if(!t)return null;const n=this.decodeAccessToken(t);return n?{id:n.sub,email:n.email,displayName:n.displayName,profilePicture:n.profilePicture}:null}async isLoggedIn(){return await this.getValidAccessToken()!==null}async logout(){try{console.log("[TokenManager] Logging out user...");try{const{error:n}=await ss.auth.signOut();n?console.error("[TokenManager] Supabase sign out error:",n):console.log("[TokenManager] âœ… Signed out from Supabase")}catch(n){console.error("[TokenManager] Error signing out from Supabase:",n)}const t=await this.getRefreshToken();if(await this.clearTokens(),t)try{await fetch("/api/auth/logout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t})}),console.log("[TokenManager] âœ… Legacy refresh token revoked on server")}catch(n){console.error("[TokenManager] Failed to revoke legacy token on server:",n)}console.log("[TokenManager] âœ… Logout complete")}catch(t){throw console.error("[TokenManager] Error during logout:",t),t}}}const qw=new BR,pfe=Object.freeze(Object.defineProperty({__proto__:null,TokenManager:BR,tokenManager:qw},Symbol.toStringTag,{value:"Module"})),uV="https://fieldsnaps.replit.app";function dV(){return Ut.isNativePlatform()?uV:""}function Vk(e){const t=dV(),n=e.startsWith("/")?e:`/${e}`;return`${t}${n}`}const hV=1,fV=2e3;let Gb=0;function pV(){return Gb=(Gb+1)%Number.MAX_SAFE_INTEGER,Gb.toString()}const Kb=new Map,uC=e=>{if(Kb.has(e))return;const t=setTimeout(()=>{Kb.delete(e),Xm({type:"REMOVE_TOAST",toastId:e})},fV);Kb.set(e,t)},mV=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,hV)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(n=>n.id===t.toast.id?{...n,...t.toast}:n)};case"DISMISS_TOAST":{const{toastId:n}=t;return n?uC(n):e.toasts.forEach(r=>{uC(r.id)}),{...e,toasts:e.toasts.map(r=>r.id===n||n===void 0?{...r,open:!1}:r)}}case"REMOVE_TOAST":return t.toastId===void 0?{...e,toasts:[]}:{...e,toasts:e.toasts.filter(n=>n.id!==t.toastId)}}},zy=[];let Wy={toasts:[]};function Xm(e){Wy=mV(Wy,e),zy.forEach(t=>{t(Wy)})}function C_({...e}){const t=pV(),n=s=>Xm({type:"UPDATE_TOAST",toast:{...s,id:t}}),r=()=>Xm({type:"DISMISS_TOAST",toastId:t});return Xm({type:"ADD_TOAST",toast:{...e,id:t,open:!0,onOpenChange:s=>{s||r()}}}),{id:t,dismiss:r,update:n}}function Lr(){const[e,t]=b.useState(Wy);return b.useEffect(()=>(zy.push(t),()=>{const n=zy.indexOf(t);n>-1&&zy.splice(n,1)}),[e]),{...e,toast:C_,dismiss:n=>Xm({type:"DISMISS_TOAST",toastId:n})}}async function zR(e){if(!e.ok){const t=await e.text()||e.statusText;throw new Error(`${e.status}: ${t}`)}}async function $n(e,t,n){const r=n instanceof FormData,s={};n&&!r&&(s["Content-Type"]="application/json");const i=await qw.getValidAccessToken();i&&(s.Authorization=`Bearer ${i}`);const a=await fetch(Vk(t),{method:e,headers:s,body:n?r?n:JSON.stringify(n):void 0,credentials:"include"});return await zR(a),a}const gV=({on401:e})=>async({queryKey:t})=>{let n="",r=null;for(let o=0;o<t.length;o++){const c=t[o];if(typeof c=="object"&&c!==null){r=c;break}o===0?n=String(c):n+=`/${String(c)}`}if(r){const o=new URLSearchParams;for(const[u,d]of Object.entries(r))d!=null&&o.append(u,String(d));const c=o.toString();c&&(n=`${n}?${c}`)}const s=await qw.getValidAccessToken(),i={};s&&(i.Authorization=`Bearer ${s}`);const a=await fetch(Vk(n),{headers:i,credentials:"include"});return e==="returnNull"&&a.status===401?null:(await zR(a),await a.json())},Ht=new dW({queryCache:new EI({onError:e=>{e instanceof Error&&!e.message.includes("401")&&C_({title:"Network Error",description:e.message||"Failed to load data. Please check your connection.",variant:"destructive",duration:4e3})}}),mutationCache:new CI({onError:e=>{e instanceof Error&&!e.message.includes("401")&&C_({title:"Operation Failed",description:e.message||"Something went wrong. Please try again.",variant:"destructive",duration:4e3})}}),defaultOptions:{queries:{queryFn:gV({on401:"throw"}),refetchInterval:!1,refetchOnWindowFocus:!1,staleTime:5*60*1e3,retry:!1},mutations:{retry:!1}}});function vV(e){return URL.createObjectURL(e.blob)}const yV="ConstructionPhotoDB",wV=1,mt={PHOTOS:"photos",PROJECTS:"projects",SYNC_QUEUE:"syncQueue",THUMBNAILS:"thumbnails"};class xV{constructor(){this.db=null,this.initPromise=null}async init(){return this.db?this.db:this.initPromise?this.initPromise:(this.initPromise=new Promise((t,n)=>{const r=window.indexedDB.open(yV,wV);r.onerror=()=>n(r.error),r.onsuccess=()=>{this.db=r.result,t(this.db)},r.onupgradeneeded=s=>{const i=s.target.result;if(!i.objectStoreNames.contains(mt.PHOTOS)){const a=i.createObjectStore(mt.PHOTOS,{keyPath:"id"});a.createIndex("projectId","projectId",{unique:!1}),a.createIndex("syncStatus","syncStatus",{unique:!1}),a.createIndex("timestamp","timestamp",{unique:!1}),a.createIndex("serverId","serverId",{unique:!1})}if(!i.objectStoreNames.contains(mt.PROJECTS)){const a=i.createObjectStore(mt.PROJECTS,{keyPath:"id"});a.createIndex("syncStatus","syncStatus",{unique:!1}),a.createIndex("serverId","serverId",{unique:!1})}if(!i.objectStoreNames.contains(mt.SYNC_QUEUE)){const a=i.createObjectStore(mt.SYNC_QUEUE,{keyPath:"id"});a.createIndex("type","type",{unique:!1}),a.createIndex("localId","localId",{unique:!1}),a.createIndex("createdAt","createdAt",{unique:!1})}i.objectStoreNames.contains(mt.THUMBNAILS)||i.createObjectStore(mt.THUMBNAILS,{keyPath:"photoId"})}}),this.initPromise)}async savePhoto(t){if(await this.isStorageLow(.8)){console.log("[IndexedDB] Storage is running low, triggering auto-cleanup");const o=await this.autoCleanupOldPhotos(.7);console.log(`[IndexedDB] Auto-cleanup freed space by deleting ${o} old photos`)}const r=await this.init(),s=crypto.randomUUID(),i=Date.now(),a={...t,id:s,createdAt:i,updatedAt:i};return new Promise((o,c)=>{const u=r.transaction([mt.PHOTOS],"readwrite"),h=u.objectStore(mt.PHOTOS).add(a);h.onsuccess=()=>o(a),h.onerror=()=>{console.error("[IndexedDB] Failed to save photo:",h.error),c(h.error)},u.onerror=()=>{console.error("[IndexedDB] Transaction error while saving photo:",u.error),c(u.error)}})}async savePhotoWithId(t,n){const r=await this.init(),s=Date.now(),i=await this.getPhoto(t),a={...n,id:t,createdAt:(i==null?void 0:i.createdAt)||s,updatedAt:s};return new Promise((o,c)=>{const u=r.transaction([mt.PHOTOS],"readwrite"),h=u.objectStore(mt.PHOTOS).put(a);h.onsuccess=()=>o(a),h.onerror=()=>{console.error("[IndexedDB] Failed to save photo with ID:",t,h.error),c(h.error)},u.onerror=()=>{console.error("[IndexedDB] Transaction error while saving photo with ID:",t,u.error),c(u.error)}})}async updatePhoto(t,n){const r=await this.init();try{const s=await this.getPhoto(t);if(!s)throw console.error("[IndexedDB] Photo not found:",t),new Error(`Photo ${t} not found`);if(typeof s!="object"||s===null)throw console.error("[IndexedDB] Invalid photo data:",{id:t,existingPhoto:s,type:typeof s}),new Error(`Invalid photo data type: ${typeof s}`);console.log("[IndexedDB] Updating photo:",{id:t,hasBlob:!!s.blob,hasAnnotations:!!s.annotations});const i={...s,...n,id:t,updatedAt:Date.now()};return new Promise((a,o)=>{const c=r.transaction([mt.PHOTOS],"readwrite"),d=c.objectStore(mt.PHOTOS).put(i);d.onsuccess=()=>a(i),d.onerror=()=>{console.error("[IndexedDB] Failed to update photo:",t,d.error),o(d.error)},c.onerror=()=>{console.error("[IndexedDB] Transaction error while updating photo:",t,c.error),o(c.error)}})}catch(s){throw console.error("[IndexedDB] updatePhoto error:",s),s}}async getPhoto(t){const n=await this.init();return new Promise((r,s)=>{const o=n.transaction([mt.PHOTOS],"readonly").objectStore(mt.PHOTOS).get(t);o.onsuccess=()=>r(o.result||null),o.onerror=()=>s(o.error)})}async getProjectPhotos(t){const n=await this.init();return new Promise((r,s)=>{const c=n.transaction([mt.PHOTOS],"readonly").objectStore(mt.PHOTOS).index("projectId").getAll(t);c.onsuccess=()=>{const u=c.result.sort((d,h)=>h.timestamp-d.timestamp);r(u)},c.onerror=()=>s(c.error)})}async updatePhotoSyncStatus(t,n,r,s){const i=await this.init(),a=await this.getPhoto(t);if(!a)throw new Error("Photo not found");return a.syncStatus=n,a.updatedAt=Date.now(),r&&(a.serverId=r),s!==void 0&&(a.syncError=s),n==="synced"&&!a.uploadedAt&&(a.uploadedAt=Date.now()),new Promise((o,c)=>{const h=i.transaction([mt.PHOTOS],"readwrite").objectStore(mt.PHOTOS).put(a);h.onsuccess=()=>o(),h.onerror=()=>c(h.error)})}async deletePhoto(t){const n=await this.init();return new Promise((r,s)=>{const i=n.transaction([mt.PHOTOS,mt.THUMBNAILS],"readwrite");i.objectStore(mt.PHOTOS).delete(t),i.objectStore(mt.THUMBNAILS).delete(t),i.oncomplete=()=>r(),i.onerror=()=>s(i.error)})}async getSessionPhotos(t){return await this.init(),new Promise(async(n,r)=>{try{const i=(await this.getAllPhotos()).filter(a=>a.sessionId===t&&a.sessionActive).sort((a,o)=>(o.timestamp||0)-(a.timestamp||0));n(i)}catch(s){r(s)}})}async cleanupSessionPhotos(t){const n=await this.init();return new Promise(async(r,s)=>{try{const a=(await this.getAllPhotos()).filter(f=>f.sessionId===t);let o=0,c=0;const u=n.transaction([mt.PHOTOS,mt.THUMBNAILS],"readwrite"),d=u.objectStore(mt.PHOTOS),h=u.objectStore(mt.THUMBNAILS);for(const f of a)f.uploadedAt&&f.syncStatus==="synced"?(d.delete(f.id),h.delete(f.id),o++):(f.sessionActive=!1,d.put(f),c++);u.oncomplete=()=>{console.log(`[IndexedDB] Session cleanup: deleted ${o} uploaded photos, cleared ${c} pending photos`),r({deleted:o,cleared:c})},u.onerror=()=>s(u.error)}catch(i){s(i)}})}async getAllPhotos(){const t=await this.init();return new Promise((n,r)=>{const a=t.transaction([mt.PHOTOS],"readonly").objectStore(mt.PHOTOS).getAll();a.onsuccess=()=>n(a.result),a.onerror=()=>r(a.error)})}async saveProject(t){const n=await this.init(),r=crypto.randomUUID(),s=Date.now(),i={...t,id:r,createdAt:s,updatedAt:s};return new Promise((a,o)=>{const d=n.transaction([mt.PROJECTS],"readwrite").objectStore(mt.PROJECTS).add(i);d.onsuccess=()=>a(i),d.onerror=()=>o(d.error)})}async getProject(t){const n=await this.init();return new Promise((r,s)=>{const o=n.transaction([mt.PROJECTS],"readonly").objectStore(mt.PROJECTS).get(t);o.onsuccess=()=>r(o.result||null),o.onerror=()=>s(o.error)})}async getAllProjects(){const t=await this.init();return new Promise((n,r)=>{const a=t.transaction([mt.PROJECTS],"readonly").objectStore(mt.PROJECTS).getAll();a.onsuccess=()=>{const o=a.result.sort((c,u)=>u.updatedAt-c.updatedAt);n(o)},a.onerror=()=>r(a.error)})}async updateProject(t,n){const r=await this.init();return new Promise(async(s,i)=>{const o=r.transaction([mt.PROJECTS],"readwrite").objectStore(mt.PROJECTS),c=o.get(t);c.onsuccess=()=>{const u=c.result;if(!u){i(new Error("Project not found"));return}const d={...u,...n,updatedAt:Date.now()},h=o.put(d);h.onsuccess=()=>s(),h.onerror=()=>i(h.error)},c.onerror=()=>i(c.error)})}async deleteProject(t){const n=await this.init(),r=await this.getProjectPhotos(t);return new Promise((s,i)=>{const a=n.transaction([mt.PROJECTS,mt.PHOTOS,mt.THUMBNAILS,mt.SYNC_QUEUE],"readwrite");a.objectStore(mt.PROJECTS).delete(t);const c=a.objectStore(mt.PHOTOS),u=a.objectStore(mt.THUMBNAILS);r.forEach(f=>{c.delete(f.id),u.delete(f.id)});const d=a.objectStore(mt.SYNC_QUEUE),h=d.getAll();h.onsuccess=()=>{h.result.filter(y=>y.localId===t||y.projectId===t||r.some(g=>g.id===y.localId)).forEach(y=>{d.delete(y.id)})},a.oncomplete=()=>s(),a.onerror=()=>i(a.error)})}async addToSyncQueue(t){const n=await this.init(),r=`${t.type}:${t.localId}:${t.action}`;return new Promise((s,i)=>{const o=n.transaction([mt.SYNC_QUEUE],"readwrite").objectStore(mt.SYNC_QUEUE),c=o.get(r);c.onsuccess=()=>{const u=c.result;if(u){const d={...t,id:r,createdAt:u.createdAt,retryCount:u.retryCount,lastAttempt:u.lastAttempt};console.log(`[IndexedDB] Queue item already exists: ${r}, updating with latest data`);const h=o.put(d);h.onsuccess=()=>s(d),h.onerror=()=>i(h.error)}else{const d={...t,id:r,createdAt:Date.now()},h=o.add(d);h.onsuccess=()=>s(d),h.onerror=()=>i(h.error)}},c.onerror=()=>i(c.error)})}async getPendingSyncItems(){const t=await this.init();return new Promise((n,r)=>{const a=t.transaction([mt.SYNC_QUEUE],"readonly").objectStore(mt.SYNC_QUEUE).getAll();a.onsuccess=()=>{const o=a.result.sort((c,u)=>c.createdAt-u.createdAt);n(o)},a.onerror=()=>r(a.error)})}async getQueueSize(){const t=await this.init();return new Promise((n,r)=>{const a=t.transaction([mt.SYNC_QUEUE],"readonly").objectStore(mt.SYNC_QUEUE).count();a.onsuccess=()=>n(a.result),a.onerror=()=>r(a.error)})}async removeFromSyncQueue(t){const n=await this.init();return new Promise((r,s)=>{const o=n.transaction([mt.SYNC_QUEUE],"readwrite").objectStore(mt.SYNC_QUEUE).delete(t);o.onsuccess=()=>r(),o.onerror=()=>s(o.error)})}async updateSyncQueueItem(t,n){const r=await this.init();return new Promise(async(s,i)=>{const o=r.transaction([mt.SYNC_QUEUE],"readwrite").objectStore(mt.SYNC_QUEUE),c=o.get(t);c.onsuccess=()=>{const u=c.result;if(!u){i(new Error("Sync queue item not found"));return}const d={...u,...n},h=o.put(d);h.onsuccess=()=>s(),h.onerror=()=>i(h.error)},c.onerror=()=>i(c.error)})}async getStorageStats(){if("storage"in navigator&&"estimate"in navigator.storage){const t=await navigator.storage.estimate(),n=t.usage||0,r=t.quota||0;return{used:n,quota:r,available:r-n}}return{used:0,quota:0,available:0}}async isStorageLow(t=.8){const n=await this.getStorageStats();return n.quota===0?!1:n.used/n.quota>=t}async autoCleanupOldPhotos(t=.7){console.log("[IndexedDB] Starting auto-cleanup of old uploaded photos");const n=await this.init();let r=0;const s=await new Promise((i,a)=>{const u=n.transaction(mt.PHOTOS,"readonly").objectStore(mt.PHOTOS).getAll();u.onsuccess=()=>{const h=u.result.filter(f=>f.uploadedAt!==null&&f.uploadedAt!==void 0).sort((f,p)=>(f.uploadedAt||0)-(p.uploadedAt||0));i(h)},u.onerror=()=>a(u.error)});console.log(`[IndexedDB] Found ${s.length} uploaded photos available for cleanup`);for(const i of s){const a=await this.getStorageStats();if(a.quota===0)break;const o=a.used/a.quota;if(o<t){console.log(`[IndexedDB] Storage now at ${(o*100).toFixed(1)}%, cleanup complete`);break}await new Promise((c,u)=>{const f=n.transaction(mt.PHOTOS,"readwrite").objectStore(mt.PHOTOS).delete(i.id);f.onsuccess=()=>{r++,console.log(`[IndexedDB] Deleted old photo ${i.id} (uploaded ${new Date(i.uploadedAt).toISOString()})`),c()},f.onerror=()=>u(f.error)})}return console.log(`[IndexedDB] Auto-cleanup complete: deleted ${r} photos`),r}async cleanupOrphanedPhotos(){console.log("[IndexedDB] Starting orphaned photo cleanup"),await this.init();const t=await this.getAllPhotos(),n=await this.getPendingSyncItems(),r=new Set(n.filter(o=>o.type==="photo").map(o=>o.localId)),s=t.filter(o=>!r.has(o.id)&&!o.serverId);console.log(`[IndexedDB] Found ${s.length} orphaned photos`);const i=await Promise.all(s.map(async o=>{let c;try{const u=await this.getProject(o.projectId);c=u==null?void 0:u.name}catch{}return{id:o.id,projectName:c,syncStatus:o.syncStatus}}));let a=0;for(const o of s)try{await this.deletePhoto(o.id),a++,console.log(`[IndexedDB] Deleted orphaned photo ${o.id} (status: ${o.syncStatus})`)}catch(c){console.error(`[IndexedDB] Failed to delete orphaned photo ${o.id}:`,c)}return console.log(`[IndexedDB] Orphaned photo cleanup complete: deleted ${a} photos`),{deleted:a,photos:i}}async clearAll(){const t=await this.init();return new Promise((n,r)=>{const s=t.transaction([mt.PHOTOS,mt.PROJECTS,mt.SYNC_QUEUE,mt.THUMBNAILS],"readwrite");s.objectStore(mt.PHOTOS).clear(),s.objectStore(mt.PROJECTS).clear(),s.objectStore(mt.SYNC_QUEUE).clear(),s.objectStore(mt.THUMBNAILS).clear(),s.oncomplete=()=>n(),s.onerror=()=>r(s.error)})}}const kt=new xV;let dC=!1;function bV(){const[e,t]=b.useState([]),[n,r]=b.useState(!0);b.useEffect(()=>{(async()=>{try{const d=await kt.getAllProjects(),h=await Promise.all(d.map(async f=>{const p=await kt.getProjectPhotos(f.serverId||f.id);return{id:f.serverId||f.id,name:f.name,description:f.description||null,address:null,city:null,state:null,zipCode:null,latitude:null,longitude:null,coverPhotoId:null,companyId:null,createdBy:null,completed:!1,coverPhotoUrl:null,createdAt:new Date(f.createdAt),lastActivityAt:new Date(f.updatedAt),deletedAt:null,userId:null,unitCount:1,unitLabels:null,customerName:null,customerPhone:null,customerEmail:null,photoCount:p.length,coverPhoto:void 0}}));t(h)}catch(d){console.error("[Offline] Failed to load projects from IndexedDB:",d),t([])}finally{r(!1)}})()},[]);const{data:s=[],isLoading:i,error:a}=An({queryKey:["/api/projects/with-counts"],staleTime:5*60*1e3,retry:!1,refetchOnMount:!1,refetchOnWindowFocus:!1,refetchOnReconnect:!1,meta:{skipErrorToast:!0}});return b.useEffect(()=>{if(dC||s.length===0)return;dC=!0,(async()=>{try{for(const d of s){const f=(await kt.getAllProjects()).find(p=>p.serverId===d.id||p.id===d.id);f?await kt.updateProject(f.id,{name:d.name,description:d.description||void 0,serverId:d.id,syncStatus:"synced",photoCount:d.photoCount}):await kt.saveProject({name:d.name,description:d.description||void 0,serverId:d.id,syncStatus:"synced",photoCount:d.photoCount})}console.log("[Offline] Saved",s.length,"projects to IndexedDB (once per session)")}catch(d){console.error("[Offline] Failed to save projects to IndexedDB:",d)}})()},[s]),{projects:s.length>0?s:e,isLoading:n&&i,isOnline:s.length>0||!a,hasLocalData:e.length>0}}/**
âœ… FOUND
bearmac@Alexs-MacBook-Pro-2 FieldSnaps % 
